init:
update KV_STORE set INT_VAL=1533888000 where name='collector-next-analysis-start';

old data stats:

insert into CLIENT_DAILY_NETFLOW(UPSTREAM,NODE_ID,DAY,SERVICE_SEQ,NETFLOW,CREATION,LAST_MODIFIED)  select CLT_TYPE=1,TICKET_CLIENT_ID,COALESCE(PVD_END_TIME,CLT_END_TIME)::date,1,(sum(COALESCE(CLT_TRANSPORT_SIZE, PVD_TRANSPORT_SIZE)))::int,now(),now() from collector.bak_action_log group by CLT_TYPE,TICKET_CLIENT_ID,COALESCE(PVD_END_TIME,CLT_END_TIME)::date having sum(COALESCE(CLT_TRANSPORT_SIZE, PVD_TRANSPORT_SIZE))>0;

insert into PROVIDER_DAILY_NETFLOW(TYPE,NODE_ID,DAY,NETFLOW,CREATION,LAST_MODIFIED) select PVD_TYPE,PVD_NODE_ID,COALESCE(PVD_END_TIME,CLT_END_TIME)::date,(sum(COALESCE(PVD_TRANSPORT_SIZE,CLT_TRANSPORT_SIZE)))::int,now(),now() from collector.bak_action_log where PVD_NODE_ID is not null and PVD_NODE_ID<>'' group by PVD_TYPE,PVD_NODE_ID,COALESCE(PVD_END_TIME,CLT_END_TIME)::date having sum(COALESCE(PVD_TRANSPORT_SIZE,CLT_TRANSPORT_SIZE))>0;

new data:

 select COALESCE(CLT_TYPE,PVD_TYPE)=1,TICKET_CLIENT_ID,COALESCE(CLT_END_TIME,PVD_END_TIME)::date,(sum(COALESCE(PVD_TRANSPORT_SIZE,CLT_TRANSPORT_SIZE)))::int from action_log where COALESCE(CLT_END_TIME,PVD_END_TIME) between '2018-08-10 09:00:00' and '2018-08-10 10:00:00' group by COALESCE(CLT_TYPE,PVD_TYPE)=1,TICKET_CLIENT_ID,COALESCE(CLT_END_TIME,PVD_END_TIME)::date having sum(COALESCE(PVD_TRANSPORT_SIZE,CLT_TRANSPORT_SIZE))>0;
 
select COALESCE(PVD_TYPE,CLT_TYPE),TICKET_PROVIDER_ID,COALESCE(PVD_END_TIME,CLT_END_TIME)::date,(sum(COALESCE(PVD_TRANSPORT_SIZE,CLT_TRANSPORT_SIZE)))::int from action_log where COALESCE(PVD_END_TIME,CLT_END_TIME) between '2018-08-10 09:00:00' and '2018-08-10 10:00:00' group by COALESCE(PVD_TYPE,CLT_TYPE),TICKET_PROVIDER_ID,COALESCE(PVD_END_TIME,CLT_END_TIME)::date having sum(COALESCE(PVD_TRANSPORT_SIZE,CLT_TRANSPORT_SIZE))>0;


SELECT NODE_ID,UPSTREAM,sum(NETFLOW+FIX_OFFSET)/1048576 FROM CLIENT_DAILY_NETFLOW  group by NODE_ID,UPSTREAM;